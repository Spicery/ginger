all:
	$(MAKE) -C apps $@
	$(MAKE) -C projects $@

clean:
	rm -rf build/appginger
	rm -f bin/common2gnx
	rm -f bin/appginger
	$(MAKE) -C apps $@
	$(MAKE) -C projects $@

distclean: clean
	rm -f Makefile
	rm -f apps/Makefile
	rm -f apps/appginger/Makefile
	rm -f apps/appginger/cpp/Makefile
	rm -f apps/appginger/functest/Makefile
	rm -f apps/appginger/unittest/Makefile
	rm -f apps/common2gnx/Makefile
	rm -f apps/common2gnx/cpp/Makefile
	rm -f apps/fetchgnx/Makefile
	rm -f apps/fetchgnx/cpp/Makefile
	rm -f apps/fetchgnx/unittest/Makefile
	rm -f apps/file2gnx/Makefile
	rm -f apps/file2gnx/cpp/Makefile
	rm -f apps/file2gnx/unittest/Makefile
	rm -f apps/libgng/Makefile
	rm -f apps/libgng/cpp/Makefile
	rm -f apps/libgng/unittest/Makefile
	rm -f apps/lisp2gnx/Makefile
	rm -f apps/lisp2gnx/lsp/Makefile
	rm -f apps/lisp2gnx/functest/Makefile
	rm -f apps/tidymnx/Makefile
	rm -f apps/tidymnx/cpp/Makefile
	rm -f apps/simplifygnx/Makefile
	rm -f apps/simplifygnx/cpp/Makefile
	rm -f apps/simplifygnx/unittest/Makefile
	rm -f apps/gson2gnx/Makefile
	rm -f apps/gson2gnx/cpp/Makefile
	rm -f apps/lnx2mnx/Makefile
	rm -f apps/lnx2mnx/cpp/Makefile
	rm -f apps/src2lnx/Makefile
	rm -f apps/src2lnx/cpp/Makefile
	rm -f apps/lnx2csv/Makefile
	rm -f apps/lnx2csv/cpp/Makefile
	rm -f projects/Makefile
	rm -f config.h
	rm -f config.status
	rm -f config.log

check: all
	$(MAKE) -C apps $@

# EPREFIX should be bound to PREFIX by default. This appears to be a lie.
# As a consequence we override EPREFIX entirely. Probably incorrect but not
# that interesting.
prefix=@prefix@
exec_prefix=@prefix@
datarootdir=@datarootdir@
PACKAGE_TARNAME=@PACKAGE_TARNAME@
INSTALL_BIN=@bindir@
INSTALL_LIB=@datarootdir@/@PACKAGE_TARNAME@
INSTALL_DOC=@docdir@

EXECUTABLES=\
	apps/appginger/cpp/appginger \
	apps/fetchgnx/cpp/fetchgnx \
	apps/file2gnx/cpp/file2gnx \
	apps/common2gnx/cpp/common2gnx \
	apps/lisp2gnx/lsp/lisp2gnx \
	apps/simplifygnx/cpp/simplifygnx \
	apps/tidymnx/cpp/tidymnx \
	apps/gson2gnx/cpp/gson2gnx \
	apps/src2lnx/cpp/src2lnx \
	apps/lnx2csv/cpp/lnx2csv \
	apps/lnx2mnx/cpp/lnx2mnx

install: all
	echo Installing binaries into $(INSTALL_BIN)
	echo Installing support files $(INSTALL_LIB)
	mkdir -p $(INSTALL_LIB)
	cp -r projects/standard_library $(INSTALL_LIB) 
	echo Installing docs into $(INSTALL_DOC)
	mkdir -p $(INSTALL_LIB)
	/usr/bin/install -m a=r COPYING $(INSTALL_LIB)
	mkdir -p $(INSTALL_LIB)/lisp2gnx
	/usr/bin/install -m a=r apps/lisp2gnx/lsp/lisp2gnx.lsp $(INSTALL_LIB)/lisp2gnx
	/usr/bin/install $(EXECUTABLES) $(INSTALL_BIN)


# Create a tarball for binary archive.
TBBASE=appginger_files
TBPREFIX=usr/local
TBMAIN=${TBBASE}/${TBPREFIX}
TBOUTPUT=appginger.tgz

tarball: all
	$(MAKE) -C documentation tarball
	rm -f build/$(TBOUTPUT)
	rm -rf build/$(TBBASE)
	mkdir -p build/$(TBPACKAGE)
	mkdir -p build/$(TBMAIN)/bin
	mkdir -p build/$(TBMAIN)/share/appginger
	gzip -d documentation/build/documentation.tgz | ( cd build/$(TBBASE)/share/appginger; tar xf - )
	( cd build_template; tar cf - . ) | ( cd build/$(TBPACKAGE); tar xf - )
	cp $(EXECUTABLES) build/$(TBMAIN)/bin/
	cp COPYING build/$(TBMAIN)/share/appginger
	cp AUTHORS build/$(TBMAIN)/share/appginger
	mkdir -p build/$(TBMAIN)/share/appginger/lisp2gnx/
	cp apps/lisp2gnx/lsp/lisp2gnx.lsp build/$(TBMAIN)/share/appginger/lisp2gnx/
	cp -r projects/standard_library build/$(TBMAIN)/share/appginger/
	find build -type d -name .svn | xargs /bin/rm -rf
	find build -name '.DS_STORE' | xargs rm -f
	find build -name '._*'
	( cd build/$(TBBASE); tar cf - . ) | gzip > build/$(TBPACKAGE)/$(TBOUTPUT)
	( cd build; tar cf - $(TBPACKAGE) ) | gzip > build/$(TBPACKAGE).tgz
