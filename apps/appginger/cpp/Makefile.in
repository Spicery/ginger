prefix=@prefix@
exec_prefix=@prefix@
datarootdir=@datarootdir@
PACKAGE_TARNAME=@PACKAGE_TARNAME@
INSTALL_BIN=@bindir@
INSTALL_TOOL=@libexecdir@/@PACKAGE_TARNAME@
INSTALL_LIB=@datarootdir@/@PACKAGE_TARNAME@
INSTALL_DOC=@docdir@

#LICENSE_FILE="$(INSTALL_LIB)/COPYING"
#LICENSE_FILE="$(INSTALL_LIB)/COPYING"

CC=@CXX@
CXX=@CXX@


INSTALLDIRS=-DINSTALL_BIN='"$(INSTALL_BIN)"' -DINSTALL_LIB='"$(INSTALL_LIB)"' -DINSTALL_TOOL='"$(INSTALL_TOOL)"'

CXXFLAGS=-DRUDECGI $(INSTALLDIRS) -g -std=c++0x -I/usr/local/include -I../hpp -I../../libgng/hpp -I../../automatic/machine -I../../automatic/sys -I../../automatic/simple -Wall -Wnon-virtual-dtor
CFLAGS=-Wmissing-prototypes

# In order to exclude machine implementations, uncomment one or more of
# the following lines.
#CXXFLAGS += -DMACHINE1_EXCLUDED
#CXXFLAGS += -DMACHINE2_EXCLUDED
#CXXFLAGS += -DMACHINE3_EXCLUDED
#CXXFLAGS += -DMACHINE4_EXCLUDED


OBJS= bigint.o rational.o sysvm.o \
	inputstreamexternal.o outputstreamexternal.o \
	cagefinder.o cell.o refprint.o vident.o codegen.o \
	simplify.o cage.o registers.o roots.o cmp.o \
	rcep.o label.o package.o \
	sys.o syscharacter.o sysmaths.o \
	syskey.o sysclass.o sysequals.o sysprint.o syslist.o sysvector.o \
	sysstring.o syssymbol.o sysmap.o sysindirection.o sysinstance.o \
	syselement.o syscheck.o sysexception.o sysdouble.o sysstack.o \
	sysstream.o  \
	syscgi.o sysattrmap.o sysmixed.o sysapply.o \
	sysfunction.o sysmethod.o sysunix.o \
	destination.o heap.o key.o \
	misclayout.o listlayout.o \
	maplayout.o functionlayout.o \
	vectorlayout.o stringlayout.o wrecordlayout.o \
	heapcrawl.o cagecrawl.o callstackcrawl.o fnobjcrawl.o \
	garbagecollect.o scanfunc.o scanpkg.o \
	machine.o instruction_set.o enginefactory.o \
	machine1.o instruction_set1.o \
	machine2.o instruction_set2.o \
	machine3.o instruction_set3.o \
	machine4.o instruction_set4.o \
	appcontext.o \
	makesysfn.o \
	toolmain.o

USEREXECUTABLES=appginger ginger-cgi ginger-script ginger-cli ginger ginger-info

all: $(USEREXECUTABLES)

################################################################################
# We need to disable optimisations based on non-overflow of integer 
# arithmetic when compiling the machine implementations. That entails
# adding the -fwrapv flag.
################################################################################

machine%.o: machine%.cpp
	$(CC) $(CXXFLAGS) -fwrapv -c $<

instruction_set%.o: instruction_set%.cpp
	$(CC) $(CXXFLAGS) -fwrapv -c $<


################################################################################
# 	Main executables
################################################################################

LIBAPPGINGER:=
ifneq ($(shell uname),Darwin)
	LIBAPPGINGER=-Wl,--whole-archive libappginger.a -Wl,--no-whole-archive
else
	LIBAPPGINGER=-Wl,-force_load libappginger.a
endif

LIBRARIES=../../libgng/cpp/libgng.a /usr/local/lib/librudecgi.a -lgmp -lgmpxx

# $@ is make shorthand for the target.
# $@ is make shorthand for the dependencies
appginger: libappginger.a main.o
	ranlib libappginger.a ../../libgng/cpp/libgng.a
	$(CC) $(CXXFLAGS) $(BOOST_CPPFLAGS) -o $@ main.o $(LIBAPPGINGER) $(LIBRARIES)
	

ginger-info: libappginger.a infomain.o
	ranlib libappginger.a ../../libgng/cpp/libgng.a
	$(CC) $(CXXFLAGS) $(BOOST_CPPFLAGS) -o $@ infomain.o $(LIBAPPGINGER) $(LIBRARIES)
	./ginger-info -H > info-debug.hlp
	./ginger-info -r > info-debug.rst

ginger-cli: libappginger.a climain.o
	ranlib libappginger.a ../../libgng/cpp/libgng.a
	$(CC) $(CXXFLAGS) $(BOOST_CPPFLAGS) -o $@ climain.o $(LIBAPPGINGER) $(LIBRARIES)

ginger-cgi: libappginger.a cgimain.o
	ranlib libappginger.a ../../libgng/cpp/libgng.a
	$(CC) $(CXXFLAGS) $(BOOST_CPPFLAGS) -o $@ cgimain.o $(LIBAPPGINGER) $(LIBRARIES)

ginger-script: libappginger.a scriptmain.o
	ranlib libappginger.a ../../libgng/cpp/libgng.a
	$(CC) $(CXXFLAGS) $(BOOST_CPPFLAGS) -o $@ scriptmain.o $(LIBAPPGINGER) $(LIBRARIES)

ginger:
	echo "#!/bin/sh" > ginger-tmp
	echo 'QUIET=false' >> ginger-tmp
	echo 'while getopts "q-:" arg; do' >> ginger-tmp
	echo '    case $$arg in' >> ginger-tmp
	echo '        q)' >> ginger-tmp
	echo '            QUIET=true;;' >> ginger-tmp
	echo '        -)' >> ginger-tmp
	echo '            case $$OPTARG in' >> ginger-tmp
	echo '                quiet) ' >> ginger-tmp
	echo '                    QUIET=true;;' >> ginger-tmp
	echo '            esac;;' >> ginger-tmp
	echo '    esac' >> ginger-tmp
	echo 'done' >> ginger-tmp
	echo 'if [ $$QUIET = false ]' >> ginger-tmp
	echo 'then' >> ginger-tmp
	echo '    echo "Ginger: @PACKAGE_VERSION@, "'`date +%Y-%m-%d`'", Copyright (c) 2010  Stephen Leach"' >> ginger-tmp
	echo '    echo "+----------------------------------------------------------------------+"'  >> ginger-tmp
	echo '    echo "| This program comes with ABSOLUTELY NO WARRANTY. It is free software, |"' >> ginger-tmp
	echo '    echo "| and you are welcome to redistribute it under certain conditions.     |"' >> ginger-tmp
	echo '    echo "| Use option --help=license for details.                               |"' >> ginger-tmp
	echo '    echo "+----------------------------------------------------------------------+"' >> ginger-tmp
	echo 'fi' >> ginger-tmp
	echo `which rlwrap`\ -pGreen\ -S\'\>\>\>\ \'\ $(INSTALL_TOOL)/ginger-cli -gcmn -q $$\@ >> ginger-tmp
	chmod a-w,a+x ginger-tmp
	mv ginger-tmp ginger

clean:
	rm -f *.o
	rm -f $(USEREXECUTABLES)
	rm -f *.a

#	Nothing needs doing.
check:
	
libappginger.a: $(OBJS)
	ar -rcs $@ $+
